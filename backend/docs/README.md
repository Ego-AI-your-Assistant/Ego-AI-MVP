# Документация по бэкенду EgoAI

Это подробное руководство по настройке, запуску, тестированию и использованию бэкенда EgoAI.

## Содержание

1.  [Обзор](#1-обзор)
2.  [Настройка среды разработки](#2-настройка-среды-разработки)
    *   [Требования](#требования)
    *   [Клонирование репозитория](#клонирование-репозитория)
    *   [Создание и активация виртуальной среды](#создание-и-активация-виртуальной-среды)
    *   [Установка зависимостей](#установка-зависимостей)
    *   [Настройка переменных среды](#настройка-переменных-среды)
3.  [Управление базой данных с помощью Alembic](#3-управление-базой-данных-с-помощью-alembic)
    *   [Настройка и создание базы данных](#настройка-и-создание-базы-данных)
    *   [Создание миграций](#создание-миграций)
    *   [Применение миграций](#применение-миграций)
    *   [Откат миграций](#откат-миграций)
4.  [Запуск приложения](#4-запуск-приложения)
5.  [Тестирование API (ручное)](#5-тестирование-api-ручное)
    *   [Swagger UI](#swagger-ui)
    *   [Инструменты для API](#инструменты-для-api)
6.  [Запуск тестов и анализ покрытия](#6-запуск-тестов-и-анализ-покрытия)
    *   [Настройка тестовой среды](#настройка-тестовой-среды)
    *   [Запуск тестов](#запуск-тестов)
    *   [Анализ покрытия кода](#анализ-покрытия-кода)
7.  [Структура проекта](#7-структура-проекта)
8.  [Развертывание (Docker)](#8-развертывание-docker)

---

## 1. Обзор

Бэкенд EgoAI построен на FastAPI с использованием SQLAlchemy для ORM и асинхронного взаимодействия с PostgreSQL. Он предоставляет RESTful API для управления пользователями, событиями, напоминаниями, взаимодействиями с ИИ и настройками пользователя. Проект следует четкой архитектуре с разделением ответственности (сервисный слой, слой доступа к данным) и поддерживает аутентификацию через Google OAuth2.

## 2. Настройка среды разработки

### Требования

Перед началом работы убедитесь, что у вас установлены следующие компоненты:

*   Python 3.9+
*   pip (менеджер пакетов Python)
*   PostgreSQL (локально или через Docker)
*   Git
*   (Необязательно) Docker и Docker Compose

### Клонирование репозитория

```bash
git clone https://github.com/your-repo/Ego_AI.git
cd Ego_AI/backend
```

### Создание и активация виртуальной среды

Настоятельно рекомендуется использовать виртуальную среду для изоляции зависимостей проекта.

**Windows:**
```bash
python -m venv venv
.\venv\Scripts\activate
```

**macOS/Linux:**
```bash
python3 -m venv venv
source venv/bin/activate
```

### Установка зависимостей

После активации виртуальной среды установите все необходимые пакеты, включая инструменты для разработки и тестирования:

```bash
pip install -r requirements.txt
```

### Настройка переменных среды

Бэкенд использует переменные среды для конфигурации (например, учетные данные базы данных, секретные ключи). Вам необходимо создать файл `.env` в корневой директории бэкенда (`Ego_AI/backend/`) на основе файла `.env.example`.

**Пример файла `.env**:**

```
# Ego_AI/backend/.env

# Основные настройки безопасности
SECRET_KEY="ВАШ_СЕКРЕТНЫЙ_КЛЮЧ_ДЛЯ_JWT" # Используйте secrets.token_urlsafe(32) для генерации
ACCESS_TOKEN_EXPIRE_MINUTES=11520 # 8 дней (60 минут * 24 часа * 8 дней)

# Настройки Google OAuth (получите их из Google Cloud Console)
GOOGLE_CLIENT_ID="ВАШ_GOOGLE_CLIENT_ID"
GOOGLE_CLIENT_SECRET="ВАШ_GOOGLE_CLIENT_SECRET"
GOOGLE_REDIRECT_URI="http://localhost:8000/api/v1/auth/google/callback" # Должен совпадать с разрешенным URI перенаправления в Google Cloud Console

# Настройки базы данных PostgreSQL
POSTGRES_SERVER="localhost" # Или имя сервиса Docker (например, db), если используете Docker Compose
POSTGRES_USER="postgres"
POSTGRES_PASSWORD="postgres" # Ваш пароль для PostgreSQL
POSTGRES_DB="egoai" # Имя вашей базы данных

# DATABASE_URL (необязательно, если указаны POSTGRES_SERVER, USER, PASSWORD, DB)
# DATABASE_URL="postgresql+asyncpg://postgres:postgres@localhost/egoai"
```

**Важно:**
*   Замените плейсхолдеры (`ВАШ_...`) на свои фактические значения.
*   Для `SECRET_KEY` сгенерируйте уникальное значение.
*   `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET` и `GOOGLE_REDIRECT_URI` необходимо получить из [Google Cloud Console](https://console.cloud.google.com/).

## 3. Управление базой данных с помощью Alembic

Alembic используется для управления всеми аспектами схемы базы данных.

### Настройка и создание базы данных

Для первоначальной настройки базы данных (создания всех таблиц с нуля) используется Alembic. **Убедитесь, что ваш сервер PostgreSQL запущен.**

Из директории `Ego_AI/backend/` выполните:

```bash
alembic upgrade head
```
Эта команда применит все существующие миграции и создаст полную структуру таблиц. **Использовать `init_db.py` больше не нужно.**

### Создание миграций

После изменения моделей SQLAlchemy (`app/database/models/models.py`) сгенерируйте новый скрипт миграции:

```bash
alembic revision --autogenerate -m "Краткое описание изменений"
```
**Всегда просматривайте сгенерированный файл** в `alembic/versions/` перед применением.

### Применение миграций

Чтобы применить новые миграции к уже существующей базе данных, используйте ту же команду:

```bash
alembic upgrade head
```

### Откат миграций

```bash
alembic downgrade -1 # Откатить на одну ревизию назад
```

## 4. Запуск приложения

После настройки переменных среды и базы данных вы можете запустить бэкенд-сервер.

Из директории `Ego_AI/backend/` выполните:

```bash
uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

*   `main:app`: Указывает Uvicorn запустить объект `app` из `main.py`.
*   `--reload`: Сервер будет автоматически перезагружаться при обнаружении изменений в коде.
*   `--host 0.0.0.0`: Делает сервер доступным извне, что полезно для Docker или для доступа с других устройств.
*   `--port 8000`: Запускает сервер на порту 8000.

Сервер будет доступен по адресу `http://localhost:8000`.

## 5. Тестирование API (ручное)

### Swagger UI

FastAPI автоматически генерирует интерактивную документацию API.

Откройте в браузере: `http://localhost:8000/api/docs`

Здесь вы можете просматривать все доступные конечные точки, их параметры, ответы и тестировать их напрямую.

### Инструменты для API

Вы можете использовать такие инструменты, как [Postman](https://www.postman.com/downloads/) или [Insomnia](https://insomnia.rest/download), или утилиту `curl` для отправки HTTP-запросов к вашим конечным точкам.

**Пример создания пользователя (POST):**

*   **URL**: `http://localhost:8000/api/users/`
*   **Метод**: `POST`
*   **Headers**: `Content-Type: application/json`
*   **Body (JSON)**:
    ```json
    {
        "email": "test@example.com",
        "password": "strongpassword123",
        "name": "Test User"
    }
    ```

**Пример получения пользователя (GET, требуется аутентификация):**

Для конечных точек, требующих аутентификации (например, через `get_current_user`), вам нужно будет получить JWT-токен (например, после успешной аутентификации через Google OAuth) и включить его в заголовок `Authorization`.

*   **URL**: `http://localhost:8000/api/users/{user_id}`
*   **Метод**: `GET`
*   **Headers**:
    ```
    Authorization: Bearer <ВАШ_JWT_ТОКЕН>
    ```

## 6. Запуск тестов и анализ покрытия

Проект содержит обширный набор интеграционных тестов с использованием `pytest`. Тесты используют отдельную базу данных для обеспечения изоляции.

### Настройка тестовой среды

Тесты настроены так, чтобы автоматически использовать тестовую базу данных (`egoai_test`). Никаких дополнительных настроек не требуется.

### Запуск тестов

Для запуска всего набора тестов выполните из директории `Ego_AI/backend/`:

```bash
pytest
```

### Анализ покрытия кода

Мы используем `coverage.py` для анализа того, какая часть кода покрыта тестами.

1.  **Запуск тестов с анализом покрытия:**
    ```bash
    coverage run -m pytest
    ```

2.  **Просмотр отчета в консоли:**
    ```bash
    coverage report -m
    ```
    Эта команда покажет краткий отчет о покрытии для каждого файла и общее покрытие.

3.  **Создание интерактивного HTML-отчета:**
    ```bash
    coverage html
    ```
    Эта команда создаст папку `htmlcov/`. Откройте файл `htmlcov/index.html` в браузере, чтобы увидеть подробный отчет, подсвечивающий выполненные и пропущенные строки кода.

## 7. Структура проекта

```
Ego_AI/
└── backend/
    ├── alembic/            # Файлы конфигурации и скрипты миграции Alembic
    ├── app/
    │   ├── api/
    │   │   ├── endpoints/  # API-конечные точки (маршруты), вызывают сервисы
    │   │   └── router.py   # Главный маршрутизатор API
    │   ├── auth/           # Модули для аутентификации (Google OAuth, JWT)
    │   ├── core/           # Базовые конфигурации (настройки, исключения, логирование)
    │   ├── database/
    │   │   ├── models/     # Определения моделей SQLAlchemy
    │   │   ├── schemas/    # Схемы Pydantic для валидации данных
    │   │   └── session.py  # Конфигурация сессий базы данных
    │   ├── services/       # Слой бизнес-логики. Инкапсулирует всю логику работы с данными.
    │   └── utils/          # Вспомогательные утилиты (зависимости, хеширование)
    ├── docs/               # Документация по проекту
    ├── tests/              # Интеграционные тесты (pytest)
    ├── .coveragerc         # Конфигурация для анализа покрытия кода
    ├── alembic.ini         # Главный конфигурационный файл Alembic
    ├── Dockerfile          # Dockerfile для бэкенда
    ├── main.py             # Главный файл приложения FastAPI
    └── requirements.txt    # Зависимости Python
```

## 8. Развертывание (Docker)

Для развертывания проекта в Docker Compose перейдите в корневую директорию проекта (`Ego_AI/`) и выполните:

```bash
docker-compose up --build -d
```
Это соберет образы Docker для бэкенда, фронтенда и PostgreSQL, а затем запустит их в фоновом режиме.

Доступ к бэкенду будет осуществляться через порт, указанный в `docker-compose.yml`.

--- 